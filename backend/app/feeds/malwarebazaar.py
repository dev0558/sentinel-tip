"""MalwareBazaar (abuse.ch) feed connector â€” free, no API key required."""

from typing import Any, List, Dict

from app.feeds.base import BaseFeed


class MalwareBazaarFeed(BaseFeed):
    name = "MalwareBazaar"
    slug = "malwarebazaar"
    feed_type = "api"
    url = "https://mb-api.abuse.ch/api/v1/"
    description = "MalwareBazaar shares malware samples and hashes"
    requires_api_key = False
    default_sync_frequency = 3600

    async def fetch(self) -> Any:
        response = await self.client.post(
            self.url,
            data={"query": "get_recent", "selector": "100"},
        )
        response.raise_for_status()
        return response.json()

    async def parse(self, raw_data: Any) -> List[Dict[str, Any]]:
        iocs = []
        data = raw_data.get("data", [])
        if not data:
            return iocs

        for entry in data:
            try:
                sha256 = entry.get("sha256_hash", "").strip()
                if not sha256:
                    continue

                tags = ["malwarebazaar", "malware"]
                if entry.get("signature"):
                    tags.append(entry["signature"].lower())
                if entry.get("tags"):
                    tags.extend([str(t).lower() for t in entry["tags"] if t])

                iocs.append(self._make_ioc(
                    ioc_type="hash",
                    value=sha256,
                    tags=tags,
                    threat_score=70,
                    confidence=80,
                    metadata={
                        "md5": entry.get("md5_hash"),
                        "sha1": entry.get("sha1_hash"),
                        "sha256": sha256,
                        "file_type": entry.get("file_type"),
                        "file_size": entry.get("file_size"),
                        "signature": entry.get("signature"),
                        "reporter": entry.get("reporter"),
                        "source": "malwarebazaar",
                    },
                ))

                # Also add MD5 and SHA1 as separate IOCs
                for hash_field in ["md5_hash", "sha1_hash"]:
                    h = entry.get(hash_field, "").strip()
                    if h:
                        iocs.append(self._make_ioc(
                            ioc_type="hash",
                            value=h,
                            tags=tags,
                            threat_score=70,
                            confidence=75,
                            metadata={"related_sha256": sha256, "source": "malwarebazaar"},
                        ))
            except Exception:
                continue

        return iocs
